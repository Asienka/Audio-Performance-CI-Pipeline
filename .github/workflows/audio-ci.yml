name: Unity Audio Performance Monitor

on:
 pull_request:
  branches:
    - main

 push:
  branches:
    - main
    
jobs:
  build:
    name: Build Unity Project
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6.0.1

    - name: Unity Builder
      uses: game-ci/unity-builder@v4
      env:
        UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
        UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      with:
        projectPath: AudioProfiling
        targetPlatform: StandaloneWindows64
        unityVersion: 2023.1.22f1

    - name: Upload build
      uses: actions/upload-artifact@v5.0.0
      with:
        name: Build-Executable
        path: build/StandaloneWindows64/

  profile:
    name: Run Build and Generate Profiler Logs
    needs: build
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6.0.1

    - name: Download build from artifacts
      uses: actions/download-artifact@v6.0.0
      with:
        name: Build-Executable
        path: Build/

    - name: List build directory
      run: dir Build/

    - name: Run executable to collect profiler data
      run: |
        echo "Running game build..."
        .\Build\StandaloneWindows64.exe
        echo "Execution finished."

    - name: Locate profiler_output.json
      shell: powershell
      run: |
        Write-Host "Searching for profiler_output.json..."
        Get-ChildItem -Recurse -Filter profiler_output.json | Select FullName

    - name: Upload profiler logs
      uses: actions/upload-artifact@v5.0.0
      with:
        name: Profiler-Logs
        path: profiler_output.json

  analyze:
    name: Analyze Audio Performance
    needs: profile
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6.0.1

    - name: Download profiler logs
      uses: actions/download-artifact@v6.0.0
      with:
        name: Profiler-Logs
        path: .

    - name: Install Python
      uses: actions/setup-python@v6.1.0
      with:
        python-version: '3.11'

    - name: Run performance analysis
      run: |
        pip install -r tools/requirements.txt || true
        python tools/parse_audioprofiler.py

    - name: Upload report
      uses: actions/upload-artifact@v5.0.0
      with:
        name: Analysis-Report
        path: report.json
