name: Unity Audio Performance Monitor

on:
 pull_request:
  branches:
    - main

 push:
  branches:
    - main
    
jobs:
  build:
    name: Build Unity Project
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Unity Builder
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: AudioProfiling
          unityVersion: 2023.1.22f1
          targetPlatform: StandaloneWindows64

      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: Build-Executable
          path: build/StandaloneWindows64/

  profile:
    name: Run Build and Generate Profiler Logs
    needs: build
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build from artifacts
        uses: actions/download-artifact@v4
        with:
          name: Build-Executable
          path: Build/

      - name: Run executable to collect profiler data
        shell: powershell
        run: |
          Write-Host "Running game build..."
          .\Build\StandaloneWindows64\AudioProfiling.exe
          Write-Host "Execution finished."

      # üîç Debug: znajd≈∫ gdzie faktycznie zapisuje siƒô JSON
      - name: Locate profiler_output.json
        shell: powershell
        run: |
          Write-Host "Searching for profiler_output.json..."
          Get-ChildItem -Recurse -Filter profiler_output.json | Select FullName

      - name: Upload profiler logs
        uses: actions/upload-artifact@v4
        with:
          name: Profiler-Logs
          path: |
            **/profiler_output.json

  analyze:
    name: Analyze Audio Performance
    needs: profile
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download profiler logs
        uses: actions/download-artifact@v4
        with:
          name: Profiler-Logs
          path: .

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run performance analysis
        run: |
          python tools/parse_audioprofiler.py profiler_output.json