name: Unity Audio Performance Monitor

on:
 pull_request:
  branches:
    - main

 push:
  branches:
    - main

concurrency:
  group: audio-profiler
  cancel-in-progress: true
  
jobs:
# ============================================================
# BUILD
# ============================================================
  build:
    name: Build Unity Project
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Cache Unity Library
      uses: actions/cache@v4
      with:
          path: AudioProfiling/Library
          key: Library-${{ runner.os }}-${{ hashFiles('AudioProfiling/Packages/manifest.json') }}

    - name: Unity Builder
      uses: game-ci/unity-builder@v4
      env:
        UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
        UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      with:
        projectPath: AudioProfiling
        targetPlatform: StandaloneWindows64
        unityVersion: 2023.1.22f1
        buildName: AudioProfiling

    - name: Upload build
      uses: actions/upload-artifact@v4
      with:
        name: Build-Executable
        path: build/StandaloneWindows64/
        retention-days: 7
# ============================================================
# PROFILE
# ============================================================
  profile:
    name: Run Build and Generate Profiler Logs
    needs: build
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@4

    - name: Download build from artifacts
      uses: actions/download-artifact@v4
      with:
        name: Build-Executable
        path: Build/

    - name: List build directory
      run: dir Build/

    - name: Run Unity build (headless)
      shell: powershell
      run: |
        $exe = Get-ChildItem -Path Build -Recurse -Filter AudioProfiling.exe | Select-Object -First 1

        if (-not $exe) {
        Write-Error "AudioProfiling.exe not found in Build/"
        exit 1
        }

        Write-Host "Running executable: $($exe.FullName)"
        Start-Process `
        -FilePath $exe.FullName `
        -ArgumentList "-batchmode -nographics -logFile `"$PWD\unity.log`"" `
        -Wait `
        -NoNewWindow

    - name: Locate profiler output
      shell: bash
      run: |
          set -euo pipefail

          COMPANY="DefaultCompany"
          PRODUCT="AudioProfiling"
          FILE="profiler_output.json"

          BASE="/c/Users/runneradmin/AppData/LocalLow"
          PATH_JSON="$BASE/$COMPANY/$PRODUCT/$FILE"

          echo "Looking for profiler output at:"
          echo "$PATH_JSON"

          if [ ! -f "$PATH_JSON" ]; then
            echo "::error::profiler_output.json not found"
            exit 1
          fi

          cp "$PATH_JSON" .
          echo "Profiler output copied to workspace"

          # sanity check
          grep -q '"sampleCount"' "$FILE"

    - name: Upload profiler logs
      uses: actions/upload-artifact@v4
      with:
        name: Profiler-Logs
        path: |
          Build/AudioProfiling_Data/profiler_output.json
          unity.log
# ============================================================
# ANALYZE
# ============================================================
  analyze:
    name: Analyze Audio Performance
    needs: profile
    runs-on: ubuntu-latest
    timeout-minutes: 10
 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download profiler logs
        uses: actions/download-artifact@v4
        with:
          name: Profiler-Logs
          path: .

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run audio performance analysis
        shell: bash
        run: |
          set -e

          if [ ! -f profiler_output.json ]; then
            echo "::error::profiler_output.json missing"
            exit 1
          fi

          python AudioProfiling/Assets/Tools/parse_audioprofiler.py profiler_output.json

      - name: Upload analysis report
        uses: actions/upload-artifact@v4
        with:
          name: Analysis-Report
          path: profiler_output.json
          retention-days: 7
