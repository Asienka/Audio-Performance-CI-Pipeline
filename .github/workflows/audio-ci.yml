name: Unity Audio Performance Monitor

on:
 pull_request:
  branches:
    - main

 push:
  branches:
    - main
    - AnalyzeAudioFix
    
jobs:
  build:
    name: Build Unity Project
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6.0.1

    - name: Unity Builder
      uses: game-ci/unity-builder@v4
      env:
        UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
        UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      with:
        projectPath: AudioProfiling
        targetPlatform: StandaloneWindows64
        unityVersion: 2023.1.22f1
        buildName: AudioProfiling

    - name: Upload build
      uses: actions/upload-artifact@v5.0.0
      with:
        name: Build-Executable
        path: build/StandaloneWindows64/

  profile:
    name: Run Build and Generate Profiler Logs
    needs: build
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6.0.1

    - name: Download build from artifacts
      uses: actions/download-artifact@v6.0.0
      with:
        name: Build-Executable
        path: Build/

    - name: List build directory
      run: dir Build/

    - name: Run Unity build (headless)
      shell: powershell
      run: |
        $exe = Get-ChildItem -Path Build -Recurse -Filter AudioProfiling.exe | Select-Object -First 1

        if (-not $exe) {
        Write-Error "AudioProfiling.exe not found in Build/"
        exit 1
        }

        Write-Host "Running executable: $($exe.FullName)"
        Start-Process `
        -FilePath $exe.FullName `
        -ArgumentList "-batchmode -nographics -logFile `"$PWD\unity.log`"" `
        -Wait `
        -NoNewWindow

    - name: Locate profiler output
      shell: powershell
      run: |
        Write-Host "Searching for profiler_output.json..."
        $profilerOutput = Get-ChildItem Build -Recurse -Filter profiler_output.json | Select-Object -ExpandProperty FullName
        if (-not $profilerOutput) {
          Write-Error "profiler_output.json not found."
          exit 1
        }
        Write-Host "Found profiler_output.json at: $profilerOutput"

    - name: Upload profiler logs
      uses: actions/upload-artifact@v5.0.0
      with:
        name: Profiler-Logs
        path: |
          Build/AudioProfiling_Data/profiler_output.json
          unity.log

  analyze:
   name: Analyze Audio Performance
   needs: profile
   runs-on: ubuntu-latest

   steps:
   - name: Checkout repository
     uses: actions/checkout@v6.0.1

   - name: Download profiler logs
     uses: actions/download-artifact@v6.0.0
     with:
       name: Profiler-Logs
       path: .

   - name: List files after downloading artifact
     run: |
        echo "Listing current directory:"
        ls -R

   - name: Install Python
     uses: actions/setup-python@v6.1.0
     with:
       python-version: '3.11'

   - name: Run performance analysis
     shell: bash
     run: |
       set -e
       if [ -f AudioProfiling/Assets/Tools/parse_audioprofiler.py ]; then
        echo "Running audio profiler parser..."
        python AudioProfiling/Assets/Tools/parse_audioprofiler.py --input Build/AudioProfiling_Data/profiler_output.json --output report.json
       else
        echo "No analysis tools found, skipping analysis"
       fi

   - name: Upload report
     uses: actions/upload-artifact@v5.0.0
     with:
       name: Analysis-Report
       path: report.json
